<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 Git Hooks 实现自动部署PHP项目 · 前端·禁地</title><meta name="description" content="使用 Git Hooks 实现自动部署PHP项目 - 梁生、"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.leungjz.top/atom.xml" title="前端·禁地"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用 Git Hooks 实现自动部署PHP项目</h1><div class="post-info">Nov 17, 2016<span id="views">1</span><span id="comments">2</span></div><div class="post-content"><p>最近正在寻找一种简便的自动部署代码到服务器的方式，然后就发现了git hooks这个方法，查了一些资料再自己尝试过后，觉得还不错，记录下。<br><a id="more"></a></p>
<h2 id="什么是git-hooks"><a href="#什么是git-hooks" class="headerlink" title="什么是git hooks"></a>什么是git hooks</h2><p>在git上是这么介绍的：</p>
<blockquote>
<p>和其它版本控制系统一样，Git能在特定的重要动作发生时触发自定义脚本。有两组这样的钩子：客户端的和服务器端的。客户端钩子由诸如提交和合并这样的操作所调用，而服务器端钩子作用于诸如接收被推送的提交这样的联网操作。 你可以随心所欲地运用这些钩子。</p>
</blockquote>
<p>我觉得可以这么理解，一个钩子就像是js中的回调，每当git完成一个动作，如<code>commit</code>，<code>push</code>等，就可以触发相对应的事件。</p>
<h2 id="git-hooks的种类"><a href="#git-hooks的种类" class="headerlink" title="git hooks的种类"></a>git hooks的种类</h2><p>git中，有两种类型的钩子：客户端的和服务器端的。</p>
<p>客户端的钩子有：</p>
<ol>
<li><p><code>pre-commit</code> 钩子在键入提交信息前运行。</p>
</li>
<li><p><code>prepare-commit-msg</code> 钩子在启动提交信息编辑器之前，默认信息被创建之后运行。</p>
</li>
<li><p><code>post-commit</code> 钩子在整个提交过程完成后运行。</p>
</li>
<li><code>applypatch-msg</code> 你可以用该脚本来确保提交信息符合格式，或直接用脚本修正格式错误。</li>
<li><code>pre-applypatch</code> 在 <code>git am</code> 运行期间被调用</li>
<li><code>post-applypatch</code> 运行于提交产生之后，是在 <code>git am</code> 运行期间最后被调用的钩子。</li>
<li><code>pre-rebase</code>  钩子运行于变基之前，以非零值退出可以中止变基的过程。</li>
<li><code>post-rewrite</code> 钩子被那些会替换提交记录的命令调用。</li>
<li><code>post-checkout</code> 在 <code>git checkout</code> 成功运行后调用。</li>
<li><code>post-merge</code> 在 <code>git merge</code> 成功运行后调用。</li>
<li><code>pre-push</code> 在 <code>git push</code> 运行期间， 更新了远程引用但尚未传送对象时被调用。</li>
<li><code>pre-auto-gc</code> 会在垃圾回收开始之前被调用，可以用它来提醒你现在要回收垃圾了，或者依情形判断是否要中断回收。</li>
</ol>
<p>服务器端的钩子有：</p>
<ol>
<li><code>pre-receive</code> 处理来自客户端的推送操作时最先被调用。</li>
<li><code>update</code> 它会为每一个准备更新的分支各运行一次。</li>
<li><code>post-receive</code> 在整个过程完结以后运行，可以用来更新其他系统服务或者通知用户。</li>
</ol>
<h2 id="如何使用git-hooks"><a href="#如何使用git-hooks" class="headerlink" title="如何使用git hooks"></a>如何使用git hooks</h2><p>所有的钩子脚本都存放在 <code>.git/hooks</code> 文件夹中。当使用 <code>git init</code> 初始化一个新版本库时，Git 默认会在这个目录中放置一些示例脚本。这些示例的名字都是以 <code>.sample</code> 结尾，如果你想启用它们，得先移除这个后缀。</p>
<h2 id="简单的自动部署"><a href="#简单的自动部署" class="headerlink" title="简单的自动部署"></a>简单的自动部署</h2><h3 id="在服务器初始化一个远程git仓库"><a href="#在服务器初始化一个远程git仓库" class="headerlink" title="在服务器初始化一个远程git仓库"></a>在服务器初始化一个远程git仓库</h3><h4 id="git-init-和-git-init-bare-的区别"><a href="#git-init-和-git-init-bare-的区别" class="headerlink" title="git init 和 git init --bare 的区别"></a><code>git init</code> 和 <code>git init --bare</code> 的区别</h4><p>初始化出来的仓库是不一样的，前者初始化的是一个普通的仓库，其中 <code>.git</code> 文件夹是隐藏的，并且能看见该仓库下所有的源码。而后者初始化出来的仓库中的文件，就是 <code>.git</code> 中的文件夹，但不能像前者那样直接浏览或修改仓库中的代码。<br><img src="git-hooks/1480143670425_4.png" alt="git init 两种初始化"></p>
<h4 id="使用-git-init-bare-初始化一个远程仓库。"><a href="#使用-git-init-bare-初始化一个远程仓库。" class="headerlink" title="使用 git init --bare 初始化一个远程仓库。"></a>使用 <code>git init --bare</code> 初始化一个远程仓库。</h4><p>该仓库是用于项目部署的。在我们本地开发完成后，将项目push至该仓库后，将自动部署网站。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$   <span class="built_in">cd</span> ~/workspace</div><div class="line">$   mkdir project</div><div class="line">$   <span class="built_in">cd</span> project</div><div class="line">$   git init --bare</div></pre></td></tr></table></figure></p>
<h3 id="在服务器初始化一个本地仓库"><a href="#在服务器初始化一个本地仓库" class="headerlink" title="在服务器初始化一个本地仓库"></a>在服务器初始化一个本地仓库</h3><p>因为php的项目基本不需要编译后运行，所以将网站的根目录作为本地仓库了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$   <span class="built_in">cd</span> /var/www/html/project</div><div class="line">$   git <span class="built_in">clone</span> ~/workspace/project</div></pre></td></tr></table></figure></p>
<p><del>之前看教程都是新建一个 <code>project</code> 文件夹再 <code>clone</code>，但是这样会将项目目录就变成了 <code>/var/www/html/project/project</code> 所以直接在根目录 <code>clone</code> 即可。</del></p>
<h3 id="为远程仓库设置一个-hook"><a href="#为远程仓库设置一个-hook" class="headerlink" title="为远程仓库设置一个 hook"></a>为远程仓库设置一个 hook</h3><p>设置一个 <code>post-receive</code> 钩子，当仓库收到push请求后，就会自动执行该钩子中的脚本。<br>现在就通过该钩子实现简单的项目部署。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"><span class="built_in">unset</span> GIT_DIR</div><div class="line"><span class="built_in">cd</span> /var/www/html/project</div><div class="line">git pull origin master</div></pre></td></tr></table></figure></p>
<p>编辑完成后，给该脚本添加可执行权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$   chmod +x post-receive</div></pre></td></tr></table></figure></p>
<h2 id="测试是否能自动部署"><a href="#测试是否能自动部署" class="headerlink" title="测试是否能自动部署"></a>测试是否能自动部署</h2><h3 id="为开发的本地仓库添加remote源"><a href="#为开发的本地仓库添加remote源" class="headerlink" title="为开发的本地仓库添加remote源"></a>为开发的本地仓库添加remote源</h3><p>这个客户端本地仓库，即开发的机子的本地仓库，添加remote源，以后往这个remote push代码时，就会自动触发上面的脚本。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$   git remote add deploy user@ip:/gitrepo_dir</div><div class="line">$   git push deploy master</div></pre></td></tr></table></figure></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在开发机上浏览项目：<br><img src="git-hooks/1480143666707_2.png" alt="第一次push"></p>
<h3 id="修改后再测试"><a href="#修改后再测试" class="headerlink" title="修改后再测试"></a>修改后再测试</h3><p>在 <code>index.php</code> 中添加一句 <code>echo &quot;这是第二次push &lt;br /&gt;&quot;;</code>。然后像平时一样，commit，push到代码仓库中（该仓库是origin而不是deploy，是平时托管代码的仓库，如github等），再push到deploy仓库中。<br>根据返回的信息，可以看出，远程服务器中已经部署成功了。<br>再次刷新浏览器，可以看到网页已经被修改了。<br><img src="git-hooks/1480143667371_3.png" alt="修改后再测试"></p>
<p>好了，一个简单的自动部署PHP项目的教程就到这了。其实，通过合理的设置 git hooks 可以实现很多功能，大家可以去慢慢挖掘。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/01/22/qiniu-js-upload/" class="prev">PREV</a><a href="/2016/10/16/vue-cli-demo/" class="next">NEXT</a></div><script id="local-count-scr" src="//localhost/blog/stat.js" defer></script><div id="hashover"></div><script id="local-count-scr" src="//hashover.leungjz.top/hashover.js" defer></script><div class="copyright"><p>© 2017 <a href="http://blog.leungjz.top">梁生、</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>